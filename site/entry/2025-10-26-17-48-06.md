---
title: 自宅サーバにForgejoでGitのホスティングサーバを立ててCloudflare Tunnel経由でアクセスする
---

# 背景

昔、
[ファイルは月別に分けて~/Documentsに置いてgitで管理しています - ncaq](https://www.ncaq.net/2017/11/06/)
に書いたように、
私はいろいろなファイルを雑に`~/Documents`ディレクトリに突っ込んでGitで管理しています。

publicリポジトリに置くことに問題がないか判別が難しいけど、
必要かすらよく分からないのでKeePassとかでいちいち管理するほどではないし、
保存する必然性があるとは限らないものを雑に置きたいのです。

Google Driveとかは一瞬オフラインだったりして競合が起きたときの挙動を明示的に制御するのが難しいので、
ファイルが壊れないGit管理にしたほうが安心です。

こういうファイルはGitHub(Microsoft)に見えるようにして良いのか今ひとつ自信が持てないので、
一応自宅サーバで管理しています。
単純にファイルサイズが大きすぎるし開発関係ないから、
GitHubのprivateリポジトリに置いたら制限とか食らいそうな気がしますし。

これまでは古い自宅サーバにGitのbareディレクトリを置いてsshでpushとpullをすることで管理していたのですが、
引っ越した際に自宅サーバをリプレースして古い自宅サーバは退役させました。

そして、
[NixOSの自宅サーバにCloudflare TunnelでHTTPリクエストを通す - ncaq](https://www.ncaq.net/2025/09/04/13/49/48/)
に書いたように新しい自宅サーバは直接IPアドレスを公開せずにCloudflare Tunnel経由でアクセスできるようにしました。

なのでこれまでのようにsshクライアントで直接Gitリポジトリにアクセスするのは難しくなりました。
新しくちゃんと解決策を考える必要があります。

また昔から、
sshクライアントがないとGitリポジトリにアクセスできないのは不便だと感じていました。
特にモバイル端末などからさっとアクセスしづらいです。
サッと外で年末調整のデータを確認したりしたい。
よってある程度webブラウザなどからもアクセスできるGitのホスティングサーバを立てたいと考えていました。

# Gitのホスティングサーバをどのソフトウェアで立てるか

そういうオープンソースのGitのホスティングサーバのソフトウェアとしては[GitLab](https://about.gitlab.com/ja-jp/)が最も有名ですが、
GitLabは商売のため仕方ないんですが全部をオープンソースにはしていないので、
どこまでオンプレミスで使えるのか今ひとつ分からないので、
ちょっと自宅サーバ上に立てたいだけの用途では考えることが多すぎて面倒です。

そこで[Forgejo – Beyond coding. We forge.](https://forgejo.org/)を使うことにしました。
これは[Gitea Official Website](https://about.gitea.com/)からOwnCloudに対するNextCloudみたいに分かれて作ったフォークプロジェクトで、
[Codeberg.org](https://codeberg.org/)などで使われている実績もあります。
個人的には[xmobar/xmobar: A minimalist status bar - Codeberg.org](https://codeberg.org/xmobar/xmobar/)の情報を見る時にCodebergはよく使いますね。
あとはアメリカの権威に屈したくない人がよく使っているイメージです。

# Cloudflare Tunnelでサーバへのアクセスポイントを通す

[feat(cloudflare): forgejo用のアクセスポイントを追加 by ncaq · Pull Request #14 · ncaq/infra.ncaq.net](https://github.com/ncaq/infra.ncaq.net/pull/14)
に書いたようにDNS recordを追記してアクセスポイントを追加します。

メインのポイント名は`forgejo.ncaq.net`にすることにしました。
役割を考えると`git.ncaq.net`みたいにするのと悩みました。
実際forgejoは一回giteaからforkしたので、
もしももう一度forkしたら名前を変える必要があります。
しかし理屈上はGitLabを別途立てるということもありえなくはないので(ほぼないけど)、
単純にソフトウェアの名前をドメイン名にすることにしました。

無料版のCloudflare Tunnelは一回のHTTPSリクエストに対して割と厳しいサイズ制限をしているので、
cloneやpushにはssh接続を使うことで回避します。
アクセス制御も簡単になりますし。

本当は`ssh.forgejo.ncaq.net`みたいにサブドメインを分けたかったのですが、
Cloudflare Tunnelの無料版では多段のサブドメイン分けをするとTLSの解決が困難なので、
妥協してssh接続のエンドポイントは`forgejo-ssh.ncaq.net`にしました。
そもそもドメインを分けたくないのですが、
それも制約上仕方がない。

# Forgejoをセットアップする

[feat(seminar): add Forgejo service and Cloudflare ingress by ncaq · Pull Request #342 · ncaq/dotfiles](https://github.com/ncaq/dotfiles/pull/342)
に書いたようにNixを使ってForgejoをセットアップしていきます。

ほぼデフォルトのままです。
nixpkgsがありがたい。

一応変更しておいた箇所をメモします。

## データベースにはPostgreSQLを使用

デフォルトの[services.forgejo.database.type](https://search.nixos.org/options?channel=25.05&show=services.forgejo.database.type&query=forgejo)
は`sqlite3`ですが、
サーバが分かれていないデータベースはメンテナンスなどが後々面倒になりがちなことを知っているので、
PostgreSQLを使うようにしました。
もともとこのサーバではPostgreSQLが動いていますし、
Nixの宣言的な記述で自動でユーザなどもセットアップされます。

## `SSH_DOMAIN`を設定

ssh接続のエンドポイントが別ドメインになっているので、
`SSH_DOMAIN`は別途設定しています。

## `COOKIE_SECURE`を有効化

全部Cloudflare Tunnel経由でアクセスするので、
TLSは有効になっていると仮定して構いません。
よってsecure属性を有効にするデメリットがないので、
`COOKIE_SECURE`を有効化しています。

## 個人専用向けに登録と閲覧を制限

今回は自分一人しか使わないことがはっきりとしているので、
アカウント登録は無効化し、
閲覧にもログインを必須化しました。

```nix
service = {
   # 個人専用向けにふさわしい設定。
   DISABLE_REGISTRATION = true; # 新規登録を無効化。
   REQUIRE_SIGNIN_VIEW = true; # サイト閲覧にログインを必須化。
 };
```

## デフォルトブランチ名を`master`に変更

意味のわからない変更はしたくないので、
`DEFAULT_BRANCH`を`master`に変更しました。

## サーバ側でアカウントの設定

web画面からのアカウント登録は無効化しているので、
サーバ側でアカウントを発行する必要があります。
forgejoのサーバ用のCLIコマンドをインストールするように設定します。

```nix
environment.systemPackages = [
  config.services.forgejo.package # サーバ上で管理CLIコマンドを使えるようにします。
];
```

ちなみに`forgejo-cli`パッケージはGitHub CLIのようなコマンドのようで、
サーバ側の管理とは少し離れています。

nixpkgsで`forgejo`や`forgejo-lts`でインストールするソフトウェアの実行コマンドは`forgejo`コマンドではなく、
名前が`gitea`のままになっていることに注意が必要です。

以下のようなコマンドでアカウントを生成できます。

```console
sudo -u forgejo gitea admin user create --username あなたのユーザー名 --password 'あなたのパスワード' --email 'your@example.com' --admin --config /var/lib/forgejo/custom/conf/app.ini
```

シェルの履歴にパスワードを残さないように注意してください。
私の環境だと先頭にスペースを入れることで回避できます。

## クライアントがcloudflare tunnel経由でssh接続するように設定

ssh接続をcloudflare tunnelを通さないといけないというのを知らずに結構はまりました。
以下のようにhome-managerの設定を追記して`~/.ssh/config`に設定を追加しました。

```nix
{ pkgs, ... }:
{
  programs.ssh = {
    enable = true;
    matchBlocks = {
      "forgejo-ssh.ncaq.net" = {
        proxyCommand = ''
          ${pkgs.cloudflared}/bin/cloudflared access ssh --hostname %h
        '';
      };
    };
  };
}
```
