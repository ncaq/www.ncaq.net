---
title: haskell.nixでのプロジェクト環境でnix flake checkでPostgreSQLへのアクセスを含むテストを実行する方法
---

# 背景

最近はNix Flakeで、
[input-output-hk/haskell.nix: Alternative Haskell Infrastructure for Nixpkgs](https://github.com/input-output-hk/haskell.nix)
を使ってHaskellプロジェクトの環境構築を行っています。

# 問題

CIの実行が遅いし定義が複雑なことに悩まされています。

[Cachix - Nix binary cache hosting](https://www.cachix.org/)
は会社のお金で契約しているのですが、
純粋にダウンロードが多すぎます。

なぜ多くなってしまうのかと言うと、
haskell.nixに限らずNixは必要なプログラムしかダウンロードしない仕組みになっているのですが、
我々のGitHub ActionsのCI定義では`nix develop`経由でコマンドを実行してしまっています。

```yaml
- name: cabal update
  run: nix develop . -c cabal update
```

この`nix develop`を実行するだけでほぼ全ての依存関係をダウンロードしてしまい、
数分かかってしまいます。

特にhaskell-language-serverは巨大であり、
今のところ人間のプログラマーにしか必要ないので、
CIではインストールしないようにしたいですよね。

# 原因

じゃあなぜ`nix develop`を使って`cabal`を直接実行しているのでしょうか?
`nix flake check`をすればテストは必要な依存関係だけで実行されるからそれで良いはずです。

何故そんなことになっているのかと言うと、
アプリケーションのテストでPostgreSQLを読み書きするので、
Nixの純粋な空間では単純にはネットワーク通信でデータベースと通信出来ないからです。

CIが遅くて複雑というだけで致命的なバグにはなってなかったので、
忙しかったというのもあって放置していました。

でも前調べたときと違ってClaude 4 Opusが出てきたので、
Claude Codeを使って探索させて、
少しそれを手直ししました。

# ソリューションはある

実はNix自体はこれへの解決策は用意しています。

[postgresqlTestHook](https://nixos.org/manual/nixpkgs/stable/#sec-postgresqlTestHook)
と言います。

これを以下のように設定すれば解決するそうです。

```nix
nativeCheckInputs = [
  postgresql
  postgresqlTestHook
];
```

しかしhaskell.nixには`nativeCheckInputs`は存在しないので、
この解決方法はそのまま使えません。

# インテグレーション

`modules`でうまく接続する必要がありました。

```nix
modules = [
  (
    { pkgs, ... }:
    let
      postgresqlTestConfig = {
        preCheck = ''
          source ${pkgs.postgresqlTestHook}/nix-support/setup-hook
          export PGUSER="postgres" # テスト内部でデータベースを作成するためにsuper userを指定。
          postgresqlStart
        '';
      };
    in
    {
      packages = {
        foo.components.tests.foo-test = postgresqlTestConfig;
      };
    }
  )
];
```

ちょっと罠なのは`postgresqlStart`は必要なのに、
`postgresqlStop`は必要ないことです。
むしろ入れると二重解放でエラーになります。
既にhookが処理しているということなのでしょうね。

もし処理してなかったとしてもNixの領域にゴミが積み立てられるだけなので、
ディスクがいっぱいになりそうになったらディスクを計測して問題のディレクトリを削除すれば良いでしょう。
