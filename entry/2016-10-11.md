---
title: ブログを作りました
tags: [blog, haskell, web]
---

# ブログを作る理由

* 月並みな話だが,アウトプットをしないと成長が鈍るからである
* 数カ月前の記憶を消失することがよくあるのでメモを取っておきたい
* 思考を文章化することによりストレスが減少するかもしれない
* 自分にとって価値のないと思う情報でも,他の人にとってはそうではないこともある

## なぜqiitaではダメなのか

[qiita](https://qiita.com/)はきわめて便利なサイトであるし,私も記事を投稿したことはあるし,よくコメントなどはする.

なぜこれをそのまま使わないか

### qiitaを使いたい理由

* 優れたmarkdownで投稿できる
* コメントシステム完備
* pull requsetが送れる
* アカウントシステムが統合されているのでコミュニケーションが取れる
* tagシステムにより読んでもらえる可能性が増える
* わざわざ自分でセットアップする必要がない
* 枯れている

### qiitaを使いたくない理由

* qiitaには技術の記事以外は投稿できないので,それ以外を書くにはやはり自前のサイトが必要
* 自分のドメインを半分もてあましている
* デザインなどを細かくカスタマイズできない
* qiitaに管理されることになる
* 自分のサイトの全てを自分で管理したいという独占欲
* 趣味

# なぜ今までブログを作らなかったか

私は数年間ブログを作らず,twitterへの書き込みですべてを済ませていた.

他の人にブログを書くことを勧められたことも数回あったが,
私は自分の書き込みをまとまった形で公開することに恐怖していた.

昔はてなダイアリーに日記があったが,それもずっと放置していて,最近削除してしまった.

それらは以下の理由によるもので,現在はそれらは解消した.

## 書くことがなかった

単純に書くことが無かった.

しかし,大学のレポートを転用したり,ソフトウェアのセットアップで詰まった点をメモしたり,障害のことについて書いたり,
割と内容があることに気が付いた.

これまでは全てtwitterで適当に済ましていたから気が付かなかったのだ.

また,いつもツイートしているような内容をまとめて書いておけば,思考が整理されて二度と同じツイートをしなくなるかもしれない.

なのでこのブログには,`~/Documents`に書き溜めた内容や,脳内記憶を適当に取り出して書いていきたい.

## プライドが高すぎた

私は非常にプライドが非常に高く,自分が低レベルだと感じるような記事の公開はしたくなかった.

本当はこんな記事を公開することも恐れている.

これは私の昔からの習性で,小学校の時から完成度が低いと感じた学校の課題の作文を提出しなかったりして,
よく親や先生に怒られていた.

つまり,私は自分の文章力が低いことがバレるのが嫌だったのである.

また,技術的な文章を書いて公開するのは絶対に嫌だった.
何故ならば,いつも私は自分の間違いを後になって気がつくからである.

1ヶ月前に書いた文章の根本的な間違いに気が付くこともしょっちゅうである.

これではブログを書いても,1週間後には根本的な間違いに気が付き,恥を感じ続ける事は不可避である.

また単純にtwitterやブログでの周り人の技術力にを恐れており,
自分の技術力の低さを恥じていた.

つまり,私は自分の技術力が低いことがバレるのが嫌だったのである.

しかし,それでは私の成長速度は遅いものになるだろう.完璧主義者の成長が低いことはよく言われる.

プライドが高く,文章力が低く,技術力が低く,自虐癖があること,
それは仕方がないことして,それを公開していくことで少しは解消させていきたい.

## ブログシステムを決められなかった

ブログを書くからには,ブログのインフラやシステムはこちらで管理したかった.

だから,はてなブログやライブドアブログは使いたくなかった.

しかし,自前で設置できるブログシステムで有名なWordPressは脆弱性の宝庫として恐怖の対象だった.

他のシステム(tdiary)もあまりパッとせず,決め手となるシステムがなかった.

なので,ブログを書こうと思っても,そのためにまずブログシステムを自作しなければいけないと考えていて,
一年前ほどから[pandoc](http://pandoc.org/MANUAL.html)と[yesod](http://www.yesodweb.com/)を組み合わせたブログシステムを作ろうとか,
それとも静的にpandocで変換するシステムを作ろうかとか構想していたが,
なかなか時間と技術力がなく,実行に移せずにいた.

しかし,この間名前は聞いていた[Hakyll](https://jaspervdj.be/hakyll/)が,
私の考えていたシステム要件をすべて満たしていると
[Hakyll, stack, Travis CI, Github でブログを管理する](http://335g.github.io/posts/2015-08-09-hakyll_travis.html)を読んで知り,衝撃を受け,さっそくこれでブログを書いてみることにした.
静的サイトなら脆弱性が存在する可能性も少ない.

私の構想がすべて無意味になってしまったのは残念だが,これでブログを書き始めることが出来て,幸いである.

というわけで衝動的にブログを作成することにした.

# hakyllによるブログの作成

私は主に[Hakyllでブログを作る(実践編) - Wake up! Good night*](https://imokuri123.com/blog/2015/12/how-to-create-blog-with-hakyll-part1.html)を参考にした.

hakyllでのブログ作成情報なんてネット上にはありふれているので,体系的な情報を書く必要はないだろう.
なので,このサイトで行ったことをあまり整理せず書いていく.

## セットアップ

`stack new blog-ncaq-net hakyll-template`で雛形を作り,デフォルトの設定を削除してカスタマイズしていく.

今はstackにtemplatesが用意されているので,`stack new`した時点でサンプルが用意されている.

未だにstackが`resolver: lts-5.18`になっていたため,普通にstackageで検索してもパッケージが出てこないことに注意する.
ltsを指定しよう.

## urlを短くする

各記事のurlは単純に`2016-10-11`のように日付だけを書くことにした.
不精な私が1日に2つも記事を書くことはないだろうし,書いたとしてもその時だけurlを崩せば十分だろう.
ファイル名からurlは自動生成されるのだから,urlには柔軟性がある.

特異なところは,hakyllのurlでは普通`posts`などのprefixがついて記事のurlがつくところが,
このブログではいきなり記事のurlが来るようになっている.

実際のこのブログでも各記事のmarkdownファイルは`entry`ディレクトリ以下に置いてあるのだが,
それはurlからは取り除かれている.

また,拡張子`.html`もなくなっている.
urlをとにかく短くしたいという思想の表れである.

実現方法はディレクトリ作ってその中にindex.htmlを作成してwebサーバに参照してもらうだけであり,具体的な方法は公式ドキュメントの
[Clean URLs with Hakyll | The Perpetual Amateur](https://www.rohanjain.in/hakyll-clean-urls/)
に書いてある.

## ハイフンをスラッシュに変換

実際のファイルのディレクトリを深くして`2016/10/17.md`のようにするのは面倒臭いが,
urlでスラッシュ以外の区切りを使うのは気持ち悪い.
なので,ファイルは`entry/2016-10-21.md`のように置き,urlは`2016/10/21/`のようになるように変更した.

みたいにハイフンをスラッシュに変更していたら,
普通にハイフンとして読み込まれるべきファイルのURLまでスラッシュにしてしまった.

あくまでハイフンを変換するのはentryのものだけであることに注意する.

## dateの自動補完

メタデータにdateをいちいち書くのは面倒臭いし,ファイル名にある情報をもう一度書くのは情報が重複して美しくない.

`dateField`のソースコードを読むと,
本来何もせずとも`parseTimeM`によってファイル名からdateは自動補完されるように見えるが,
`[ERROR] Missing field $date$ in context for item entry/2016-10-11.md`というエラーが出て非常に悩んだ.

数時間悩んでもよくわからなかったので,日時のフォーマットなどを無視して,
ファイル名から日だけを取り出すという荒業で解決させた.
私だけに影響する関数なので,私がファイル名をちゃんと守れば実用上の問題はない.
とはいえ,少し気持ちが悪い.

## pandocの設定編集

`section`好きなので,html5で出力されるように設定した.

残念ながら読む場所が違うのか`pandoc_title_block`は使えないようなので,おとなしくyamlでタイトルを書くことにします.

## pandocの目次追加

pandocによる目次がデフォルト状態だと追加されなかったので,
`writerStandalone = True`と`writerTemplate = unlines ["$toc$", "$body$"]`を設定することで埋め込むように設定.

## feed配信

atomを使うかrss2.0を使うか少し悩んだが,atomの方が少しシンプルだったので,そちらを使うことにした.

特にidが必須というのがわかりやすい.

## feedのidにindex.htmlがついてしまう問題を修正

`withUrls`はhref属性などurlっぽい文字列のみしか対策しないため,`entryContext`の`url`フィールドごと
index.htmlを抹消する.

~~~hs
field "url" (fmap (maybe empty (cleanIndex . toUrl)) . getRoute . itemIdentifier)
~~~

## もともとあったサイトをブログに取り込む

私はもともと単純な自己紹介を書いたwebページを公開していたのだが,
それもまた単なる静的webサイトであるし,わざわざ分けている必要もない.

もともとそのサイトは`www.ncaq.net`として公開し,ブログは`blog.ncaq.net`として公開するつもりだった.

しかし,サブドメインを分ける主なメリットは,オリジンを分けてcookieの名前空間を衝突しないようにすることである.
静的サイトがそのメリットを受けることは少ない.

これを機に,hakyllに統一してしまい,もともとのwebサイトはaboutページとして保存することにした.

gitリポジトリを別々に管理していたため,リポジトリを統合する方法を検索して実行した.
`merge`に`--allow-unrelated-histories`オプションをつければ,整合性の無さを無視してmerge出来るようだ.

~~~sh
2016-10-17T09:07:44 ncaq@nonohara/pts/0(0) ~/Desktop/www.ncaq.net
% git remote add blog https://github.com/ncaq/blog.ncaq.net.git
2016-10-17T09:10:02 ncaq@nonohara/pts/0(1) ~/Desktop/www.ncaq.net
% git fetch blog
From https://github.com/ncaq/blog.ncaq.net
 * [new branch]      master     -> blog/master
2016-10-17T09:10:05 ncaq@nonohara/pts/0(0) ~/Desktop/www.ncaq.net
% git merge blog/master --allow-unrelated-histories
Auto-merging index.html
CONFLICT (add/add): Merge conflict in index.html
Auto-merging .gitignore
CONFLICT (add/add): Merge conflict in .gitignore
Automatic merge failed; fix conflicts and then commit the result.
~~~

## indent

動的webフレームワークではインデントは諦めて,むしろパフォーマンスのために圧縮するhtmlですが,
静的サイトなので出力されたhtmlを目で確認することもそこそこあるので,
html tidyによってインデントを美しく整えておくことにした.

もちろんpandocはデフォルトでhtmlをインデントしてくれるのですが,
テンプレート埋め込みが絡むと整合性が取れません.

また,feedはatomで配信しているのですが,こちらはブラウザのinspectorでデバッグするのも難しく,
目で構造を確認するしかないので,このxmlをインデントしておくことは特に重要である.

`unixFilter`を使うとちょっとした警告でも失敗扱いになるので,
自前で`readProcessWithExitCode`することで対処.

## html

[Haskellでブログを作った | eliza.link](https://eliza.link/posts/create_blog_with_hakyll.html)

を参考にして,shakespeareを使おうかと思いましたが,
shakespeare templateの強みは型安全変数による安全な変数の埋め込みなので,
変数が静的に解決されるhakyllではあまり意味がないので,やめておきました.

## css

[Clay, CSS Preprocessor](http://fvisser.nl/clay/)をせっかくなので使ってみることにしました.
Scssから移行する意味は全くもって無いのですが,せっかくなので新しい言語を使ってみたい.

cssを型付けする意味はあまりないと予想して,実際あまりありませんでしたが,
タイプミスやわけのわからん記法を使うのを防止する意味はあった.

デザインは趣味なのでcss frameworkとか使わずに適当に組んだ.

## js

typescriptでjsを1ファイル作ってそれで済ますことにした.

google analyticsとhighlight.jsを設定した.

## デプロイ

github pagesで公開している方が多いみたいですが,github pagesの仕様とすりあわせるのが面倒なので,自宅サーバにデプロイすることにしました.

せっかく`deploy`コマンドもあることですし,どうせ記事公開前には1回ぐらいはローカルで確認するので,travis ciの自動デプロイはあまり魅力的ではありません.

# これから何を書いていくか

* 魅力的なソフトウェアの紹介
* ソフトウェアの設定
* プログラム断片
* これまで書いたことの焼き直し
* 愚痴
* ポエム

などを予定しています.
